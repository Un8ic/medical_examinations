import os
from flask import Flask, render_template, request, redirect, url_for, flash, jsonify
import sqlite3
import logging

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'dev-secret-key-2024')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def get_db_connection():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect('medical_db.db')
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    try:
        with app.app_context():
            conn = get_db_connection()

            # –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–ª–µ–π –∑–¥–æ—Ä–æ–≤—å—è
            conn.execute('''
                CREATE TABLE IF NOT EXISTS health_goals (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    title TEXT NOT NULL,
                    description TEXT,
                    icon TEXT
                )
            ''')

            # –¢–∞–±–ª–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–æ–≤
            conn.execute('''
                CREATE TABLE IF NOT EXISTS analyses (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    goal_id INTEGER NOT NULL,
                    name TEXT NOT NULL,
                    reason TEXT NOT NULL,
                    FOREIGN KEY (goal_id) REFERENCES health_goals (id)
                )
            ''')

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
            existing_goals = conn.execute('SELECT COUNT(*) AS count FROM health_goals').fetchone()['count']

            if existing_goals == 0:
                logger.info("–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...")
                
                goals_data = [
                    ('ü§∞ –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å', '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–µ–¥–µ–Ω–∏–µ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏', 'pregnancy'),
                    ('üí™ –°–ø–æ—Ä—Ç', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–∫—Ç–∏–≤–Ω—ã–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –Ω–∞–≥—Ä—É–∑–∫–∞–º', 'sport'),
                    ('üîç –ß–µ–∫–∞–ø', '–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–º–∞', 'checkup'),
                    ('‚öñÔ∏è –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω', '–û—Ü–µ–Ω–∫–∞ —Ä–∞–±–æ—Ç—ã —ç–Ω–¥–æ–∫—Ä–∏–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', 'hormones'),
                    ('‚ù§Ô∏è –ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è', '–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã', 'cardio'),
                    ('üß† –ù–µ–≤—Ä–æ–ª–æ–≥–∏—è', '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', 'neuro')
                ]

                analyses_data = [
                    # –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å
                    (1, '–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏', '–û—Ü–µ–Ω–∫–∞ –æ–±—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è, –≤—ã—è–≤–ª–µ–Ω–∏–µ –∞–Ω–µ–º–∏–∏, –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤'),
                    (1, '–ì–ª—é–∫–æ–∑–∞ –∫—Ä–æ–≤–∏', '–°–∫—Ä–∏–Ω–∏–Ω–≥ –Ω–∞ –≥–µ—Å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∏–∞–±–µ—Ç'),
                    (1, '–¢–¢–ì (—Ç–∏—Ä–µ–æ—Ç—Ä–æ–ø–Ω—ã–π –≥–æ—Ä–º–æ–Ω)', '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ —â–∏—Ç–æ–≤–∏–¥–Ω–æ–π –∂–µ–ª–µ–∑—ã, –≤–∞–∂–Ω–æ–π –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –ø–ª–æ–¥–∞'),
                    (1, 'TORCH-–∫–æ–º–ø–ª–µ–∫—Å', '–í—ã—è–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–µ–∫—Ü–∏–π, –æ–ø–∞—Å–Ω—ã—Ö –¥–ª—è –ø–ª–æ–¥–∞'),
                    
                    # –°–ø–æ—Ä—Ç
                    (2, '–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏', '–û—Ü–µ–Ω–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∑–¥–æ—Ä–æ–≤—å—è –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ–∫'),
                    (2, '–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω –∏ –º–æ—á–µ–≤–∏–Ω–∞', '–û—Ü–µ–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—á–µ–∫ –ø—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö'),
                    (2, '–ê–õ–¢, –ê–°–¢', '–û—Ü–µ–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—á–µ–Ω–∏'),
                    (2, '–≠–ö–ì', '–û—Ü–µ–Ω–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–¥—Ü–∞ –ø–µ—Ä–µ–¥ –Ω–∞–≥—Ä—É–∑–∫–∞–º–∏'),
                    
                    # –ß–µ–∫–∞–ø
                    (3, '–ë–∏–æ—Ö–∏–º–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏', '–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ä–≥–∞–Ω–æ–≤'),
                    (3, '–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –º–æ—á–∏', '–û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ—á–µ–≤—ã–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã'),
                    (3, '–•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –∏ –ª–∏–ø–∏–¥–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å', '–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ —Å–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π'),
                    (3, '–ì–ª–∏–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–µ–º–æ–≥–ª–æ–±–∏–Ω', '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∞—Ö–∞—Ä–Ω–æ–≥–æ –¥–∏–∞–±–µ—Ç–∞'),
                    
                    # –ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
                    (4, '–¢–¢–ì, –¢4 —Å–≤–æ–±–æ–¥–Ω—ã–π', '–û—Ü–µ–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ —â–∏—Ç–æ–≤–∏–¥–Ω–æ–π –∂–µ–ª–µ–∑—ã'),
                    (4, '–ö–æ—Ä—Ç–∏–∑–æ–ª', '–û—Ü–µ–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–¥–ø–æ—á–µ—á–Ω–∏–∫–æ–≤ –∏ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–µ—Å—Å'),
                    (4, '–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω', '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π —Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏'),
                    (4, '–≠—Å—Ç—Ä–∞–¥–∏–æ–ª', '–û—Ü–µ–Ω–∫–∞ –∂–µ–Ω—Å–∫–æ–≥–æ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–∞'),
                    
                    # –ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è
                    (5, '–≠–ö–ì', '–ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ —Ä–∏—Ç–º–∞'),
                    (5, '–õ–∏–ø–∏–¥–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å', '–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ –∞—Ç–µ—Ä–æ—Å–∫–ª–µ—Ä–æ–∑–∞'),
                    (5, '–¢—Ä–æ–ø–æ–Ω–∏–Ω', '–ú–∞—Ä–∫–µ—Ä –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è —Å–µ—Ä–¥–µ—á–Ω–æ–π –º—ã—à—Ü—ã'),
                    
                    # –ù–µ–≤—Ä–æ–ª–æ–≥–∏—è
                    (6, '–ú–†–¢ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–æ–∑–≥–∞', '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–æ–∑–≥–∞'),
                    (6, '–≠–≠–ì', '–û—Ü–µ–Ω–∫–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–æ–∑–≥–∞'),
                    (6, '–í–∏—Ç–∞–º–∏–Ω B12', '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–∞, –≤–ª–∏—è—é—â–µ–≥–æ –Ω–∞ –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É')
                ]

                cursor = conn.cursor()
                cursor.executemany(
                    'INSERT INTO health_goals (title, description, icon) VALUES (?, ?, ?)', 
                    goals_data
                )
                cursor.executemany(
                    'INSERT INTO analyses (goal_id, name, reason) VALUES (?, ?, ?)', 
                    analyses_data
                )
                
                conn.commit()
                logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

            conn.close()
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return render_template('index.html')

@app.route('/enter_as_guest')
def enter_as_guest():
    """–í—Ö–æ–¥ –∫–∞–∫ –≥–æ—Å—Ç—å"""
    flash('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å. –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.', 'success')
    return redirect(url_for('goal_constructor'))

@app.route('/goal_constructor')
def goal_constructor():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Ü–µ–ª–µ–π"""
    try:
        conn = get_db_connection()
        health_goals = conn.execute('SELECT * FROM health_goals').fetchall()
        conn.close()
        return render_template('goal_constructor.html', health_goals=health_goals)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–π: {e}")
        flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö', 'error')
        return render_template('goal_constructor.html', health_goals=[])

@app.route('/get_analyses/<int:goal_id>')
def get_analyses(goal_id):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ –ø–æ —Ü–µ–ª–∏"""
    try:
        conn = get_db_connection()
        analyses = conn.execute(
            'SELECT name, reason FROM analyses WHERE goal_id = ?', (goal_id,)
        ).fetchall()
        conn.close()

        analyses_list = [
            {'name': analysis['name'], 'reason': analysis['reason']} 
            for analysis in analyses
        ]
        
        return jsonify({'analyses': analyses_list})
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤: {e}")
        return jsonify({'error': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö'}), 500

@app.route('/login', methods=['POST'])
def login():
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞"""
    flash('üîß –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–µ–Ω –≥–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥.', 'info')
    return redirect(url_for('index'))

@app.route('/register', methods=['POST'])
def register():
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    flash('üîß –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è.', 'info')
    return redirect(url_for('index'))

@app.errorhandler(404)
def not_found(error):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ 404 –æ—à–∏–±–∫–∏"""
    return render_template('index.html'), 404

@app.errorhandler(500)
def internal_error(error):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ 500 –æ—à–∏–±–∫–∏"""
    flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'error')
    return render_template('index.html'), 500

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    init_db()
    app.run(host='0.0.0.0', port=port, debug=False)